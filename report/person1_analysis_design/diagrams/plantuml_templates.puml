@startuml 01_use_case_diagram
' Use Case Diagram - Battleship Multiplayer
' Copy this section and render at https://www.plantuml.com/plantuml/

left to right direction
skinparam packageStyle rectangle

actor Player
actor "Server System" as Server

rectangle "Battleship Multiplayer System" {
  ' Player use cases
  Player -- (Register Account)
  Player -- (Login)
  Player -- (View Player List)
  Player -- (Send Challenge)
  Player -- (Accept/Decline Challenge)
  Player -- (Place Ships)
  Player -- (Make Move)
  Player -- (View Match Results)
  Player -- (Logout)

  ' Use case relationships
  (Register Account) ..> (Validate Username) : <<include>>
  (Login) ..> (Validate Credentials) : <<include>>
  (Login) <.. (Auto-Login) : <<extend>>
  (Send Challenge) ..> (View Player List) : <<require>>
  (Place Ships) ..> (Accept Challenge) : <<require>>
  (Make Move) ..> (Place Ships) : <<require>>

  ' Server use cases
  Server -- (Manage Sessions)
  Server -- (Track Online Players)
  Server -- (Route Challenges)
  Server -- (Create Match)
  Server -- (Validate Game Moves)
  Server -- (Update ELO Ratings)
  Server -- (Store Match History)
}

@enduml

@startuml 02_system_architecture
' System Architecture Diagram
' Three-tier architecture

!define LIGHTBLUE #ADD8E6
!define LIGHTGREEN #90EE90
!define LIGHTYELLOW #FFFFE0

package "Client Application" LIGHTBLUE {
  [UI Manager\n(GTK)]
  [Login Screen]
  [Lobby Screen]
  [Game Board]

  [Client Network\n(TCP Client)]
  [Session Storage\n(~/.battleship)]

  [UI Manager\n(GTK)] --> [Login Screen]
  [UI Manager\n(GTK)] --> [Lobby Screen]
  [UI Manager\n(GTK)] --> [Game Board]

  [UI Manager\n(GTK)] --> [Client Network\n(TCP Client)]
  [UI Manager\n(GTK)] --> [Session Storage\n(~/.battleship)]
}

package "Server Application" LIGHTGREEN {
  [Server\n(Multi-threaded\nTCP Listener)]

  [Auth Handler]
  [Player Handler]
  [Challenge Handler]

  [Database Manager]
  [Player Manager]
  [Challenge Manager]

  [Server\n(Multi-threaded\nTCP Listener)] --> [Auth Handler]
  [Server\n(Multi-threaded\nTCP Listener)] --> [Player Handler]
  [Server\n(Multi-threaded\nTCP Listener)] --> [Challenge Handler]

  [Auth Handler] --> [Database Manager]
  [Player Handler] --> [Player Manager]
  [Challenge Handler] --> [Challenge Manager]
}

database "SQLite Database" LIGHTYELLOW {
  [users]
  [sessions]
  [matches]
  [match_boards]
  [match_moves]
}

[Client Network\n(TCP Client)] -down-> [Server\n(Multi-threaded\nTCP Listener)] : TCP Socket\n(Port 9999)
[Database Manager] -down-> [users]
[Database Manager] -down-> [sessions]
[Database Manager] -down-> [matches]

@enduml

@startuml 03_authentication_flow_register
' Authentication Flow - Registration

participant "Client" as C
participant "Server" as S
database "Database" as DB

C -> S: REGISTER_REQUEST\n(username, password)
activate S

S -> DB: Check username exists
activate DB
DB --> S: Username available
deactivate DB

S -> S: Hash password\n(SHA-256 + salt)

S -> DB: INSERT INTO users\n(username, password_hash)
activate DB
DB --> S: user_id created
deactivate DB

S -> DB: Generate session token\nINSERT INTO sessions
activate DB
DB --> S: Session created
deactivate DB

S --> C: REGISTER_RESPONSE\n(success, user_id, token)
deactivate S

C -> C: Save session locally\n(~/.battleship/session.txt)
C -> C: Show main menu

@enduml

@startuml 03_authentication_flow_login
' Authentication Flow - Login

participant "Client" as C
participant "Server" as S
database "Database" as DB

C -> S: LOGIN_REQUEST\n(username, password)
activate S

S -> DB: SELECT * FROM users\nWHERE username=?
activate DB
DB --> S: User data + password_hash
deactivate DB

S -> S: Verify password\n(constant-time compare)

S -> DB: Generate new token\nINSERT/UPDATE sessions
activate DB
DB --> S: Session created
deactivate DB

S --> C: LOGIN_RESPONSE\n(success, token, user_info)
deactivate S

C -> C: Save session locally
C -> C: Show main menu

@enduml

@startuml 03_authentication_flow_autologin
' Authentication Flow - Auto-Login

participant "Client" as C
participant "Server" as S
database "Database" as DB

C -> C: App starts
C -> C: Load session from\n~/.battleship/session.txt
C -> C: Found: user_id, token

C -> S: Connect to server
C -> S: VALIDATE_SESSION\n(user_id, token)
activate S

S -> DB: SELECT * FROM sessions\nWHERE user_id=?\nAND session_token=?
activate DB
DB --> S: Session data
deactivate DB

S -> S: Check expires_at\n> current_time?

alt Valid session
  S --> C: VALIDATE_RESPONSE\n(valid=true, user_info)
  deactivate S
  C -> C: Show main menu\n(skip login screen)
else Invalid session
  S --> C: VALIDATE_RESPONSE\n(valid=false)
  deactivate S
  C -> C: Clear session
  C -> C: Show login screen
end

@enduml

@startuml 04_matchmaking_flow_challenge
' Matchmaking Flow - Direct Challenge

participant "Player A" as A
participant "Server" as S
participant "Player B" as B
database "Database" as DB

A -> S: CHALLENGE_SEND\n(target_user_id=B)
activate S

S -> S: Validate:\n- A authenticated\n- B online\n- B available\n- Not self-challenge

S -> S: Store in ChallengeManager\n(60s timeout)

S -> B: CHALLENGE_RECEIVED\n(challenge_id, A_info)
activate B
B -> B: Show dialog:\n"Player A challenges you!"
deactivate B

B -> S: CHALLENGE_RESPONSE\n(challenge_id, accept=true)

S -> DB: INSERT INTO matches\n(player1_id=A,\nplayer2_id=B,\nstatus=waiting_ships)
activate DB
DB --> S: match_id=123
deactivate DB

S -> S: Set A status=IN_GAME\nSet B status=IN_GAME

S -> A: MATCH_START\n(match_id=123)
activate A
A -> A: Transition to\nShip Placement
deactivate A

S -> B: MATCH_START\n(match_id=123)
activate B
B -> B: Transition to\nShip Placement
deactivate B

deactivate S

@enduml

@startuml 04_matchmaking_flow_timeout
' Matchmaking Flow - Challenge Timeout

participant "Player A" as A
participant "Server" as S
participant "Player B" as B

A -> S: CHALLENGE_SEND
activate S
S -> S: Store with timestamp\ncreated_at = now()
S -> B: CHALLENGE_RECEIVED
deactivate S

... 60 seconds pass ...

B -> B: User doesn't respond

S -> S: Background thread\nchecks timeout:\nnow() - created_at > 60s

S -> S: Remove challenge\nfrom pending map

S -> A: CHALLENGE_TIMEOUT\n(challenge_id, reason="timeout")
activate A
A -> A: Show notification:\n"Player B did not respond"
A -> A: Back to lobby
deactivate A

S -> B: CHALLENGE_TIMEOUT\n(challenge_id)
activate B
B -> B: Dialog auto-closes
deactivate B

@enduml

@startuml 06_database_er_diagram
' Database ER Diagram

entity "users" as users {
  * user_id : INTEGER <<PK>>
  --
  * username : TEXT <<UNIQUE>>
  * password_hash : TEXT
  * display_name : TEXT
    elo_rating : INTEGER = 1200
    created_at : DATETIME
    last_login : DATETIME
}

entity "sessions" as sessions {
  * session_id : INTEGER <<PK>>
  --
  * user_id : INTEGER <<FK>>
  * session_token : TEXT <<UNIQUE>>
  * created_at : DATETIME
  * expires_at : DATETIME
}

entity "matches" as matches {
  * match_id : INTEGER <<PK>>
  --
  * player1_id : INTEGER <<FK>>
  * player2_id : INTEGER <<FK>>
    winner_id : INTEGER <<FK>>
  * status : TEXT
  * created_at : DATETIME
    ended_at : DATETIME
}

entity "match_boards" as boards {
  * board_id : INTEGER <<PK>>
  --
  * match_id : INTEGER <<FK>>
  * user_id : INTEGER <<FK>>
  * ship_data : TEXT (JSON)
}

entity "match_moves" as moves {
  * move_id : INTEGER <<PK>>
  --
  * match_id : INTEGER <<FK>>
  * player_id : INTEGER <<FK>>
  * move_number : INTEGER
  * x : INTEGER
  * y : INTEGER
  * result : TEXT
  * timestamp : DATETIME
}

users ||--o{ sessions : "has"
users ||--o{ matches : "plays in"
matches ||--|{ boards : "contains"
matches ||--o{ moves : "records"

@enduml

@startuml 07_class_diagram
' Class Diagram - Server and Client

package "Server" {
  class Server {
    - server_fd : int
    - running : bool
    - clients : map<int, ClientInfo*>
    - db : DatabaseManager*
    - playerManager : PlayerManager*
    - challengeManager : ChallengeManager*
    --
    + Server(port : int)
    + ~Server()
    + start() : void
    + stop() : void
    - handleClient(client_fd : int) : void
    + broadcast(msg, exclude_fd) : void
  }

  class DatabaseManager {
    - db : sqlite3*
    --
    + createUser() : int
    + validateLogin() : bool
    + createSession() : string
    + validateSession() : bool
    + createMatch() : int
    + getUser() : UserInfo
  }

  class PlayerManager {
    - players : map<user_id, PlayerData>
    - mutex : std::mutex
    --
    + addPlayer(user_id, fd, info) : void
    + removePlayer(user_id) : void
    + updateStatus(user_id, status) : void
    + getOnlinePlayers() : vector<PlayerInfo>
    + getPlayerInfo(user_id) : PlayerInfo
  }

  class ChallengeManager {
    - pending : map<id, Challenge>
    - nextId : uint32_t
    - mutex : std::mutex
    --
    + sendChallenge() : uint32_t
    + respondToChallenge() : bool
    + removeChallenge() : void
    + checkTimeouts() : void
  }

  class AuthHandler {
    - db : DatabaseManager*
    - server : Server*
    --
    + handleRegister() : void
    + handleLogin() : void
    + handleValidateSession() : void
    + handleLogout() : void
  }

  Server *-- DatabaseManager
  Server *-- PlayerManager
  Server *-- ChallengeManager
  Server ..> AuthHandler : uses
}

package "Client" {
  class UIManager {
    - window : GtkWidget*
    - currentScreen : Screen
    - clientNetwork : ClientNetwork*
    - sessionStorage : SessionStorage*
    --
    + UIManager()
    + initialize() : bool
    + showLoginScreen() : void
    + showLobbyScreen() : void
    + showGameScreen() : void
    - handleLogin() : void
    - handleRegister() : void
    - autoLogin() : void
  }

  class ClientNetwork {
    - socket_fd : int
    - connected : bool
    --
    + connect() : bool
    + sendRegister() : bool
    + sendLogin() : bool
    + validateSession() : bool
    + requestPlayerList() : void
    + sendChallenge() : void
    + sendMove() : void
  }

  class SessionStorage {
    - sessionPath : string
    --
    + saveSession() : void
    + loadSession() : SessionData
    + clearSession() : void
    + hasSession() : bool
  }

  UIManager *-- ClientNetwork
  UIManager *-- SessionStorage
}

@enduml

' To use these templates:
' 1. Copy the section you want (between @startuml and @enduml)
' 2. Go to https://www.plantuml.com/plantuml/uml/
' 3. Paste the code
' 4. Click "Submit"
' 5. Download PNG (right-click on image)
'
' Alternatively, install PlantUML locally:
' - sudo apt-get install plantuml
' - plantuml thisfile.puml
' - Will generate PNG files
